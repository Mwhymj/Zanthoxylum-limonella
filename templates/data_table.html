<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏∞‡πÅ‡∏Ç‡∏ß‡πà‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { display: flex; margin: 0; font-family: 'Sarabun', sans-serif; background: #f4f7f6; }
        
        /* Sidebar ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Dashboard */
        .sidebar { width: 260px; background: #1b5e20; color: white; padding: 20px; min-height: 100vh; position: fixed; display: flex; flex-direction: column; z-index: 1000; }
        .sidebar h3 { font-size: 20px; display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .sidebar p { font-size: 14px; opacity: 0.9; margin-bottom: 20px; }
        
        .nav-menu { list-style: none; padding: 0; flex-grow: 1; }
        .nav-menu a { color: white; text-decoration: none; display: block; padding: 12px 15px; border-radius: 8px; transition: 0.3s; font-size: 14px; margin-bottom: 5px; }
        .nav-menu a:hover { background: rgba(255,255,255,0.1); }
        .nav-menu a.active { background: rgba(255,255,255,0.2); font-weight: bold; }
        
        /* Main Content */
        .main { flex-grow: 1; padding: 30px; margin-left: 260px; width: calc(100% - 260px); }
        .table-container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        h2 { color: #1b5e20; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
        
        /* Elements */
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; text-decoration: none; display: inline-block; margin: 2px; transition: 0.3s; }
        .btn-del { background: #ff5252; color: white; }
        .btn-del:hover { background: #b71c1c; }
        .btn-map { background: #4caf50; color: white; }
        .btn-map:hover { background: #2e7d32; }
        
        .btn-excel { background: #2e7d32 !important; color: white !important; border: none !important; margin-bottom: 15px !important; border-radius: 5px !important; }
        .btn-csv { background: #546e7a !important; color: white !important; border: none !important; margin-bottom: 15px !important; border-radius: 5px !important; }
        
        .badge-ai { padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 11px; }
        .bg-zantho { background: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
        .bg-other { background: #fff3e0; color: #ef6c00; border: 1px solid #ef6c00; }
        
        .logout-btn { color: #ffcdd2; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 10px; padding: 12px 15px; border: 1px solid rgba(255,205,210,0.3); border-radius: 8px; transition: 0.3s; margin-top: auto; }
        .logout-btn:hover { background: #b71c1c; color: white; }

        table.dataTable img { border-radius: 8px; cursor: pointer; transition: 0.3s; object-fit: cover; border: 1px solid #eee; }
        table.dataTable img:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3><i class="fa-solid fa-leaf"></i> ‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏∞‡πÅ‡∏Ç‡∏ß‡πà‡∏ô</h3>
        <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b>{{ session.get('user', 'Admin') }}</b><br>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: <span style="color: #ffeb3b;">{{ role.upper() }}</span></p>
        <hr style="opacity: 0.2; width: 100%; margin-bottom: 20px;">
        
        <nav class="nav-menu">
            <a href="/dashboard"><i class="fa-solid fa-map-location-dot"></i> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°</a>
            <a href="/data_table" class="active"><i class="fa-solid fa-folder-open"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏ñ‡πà‡∏≤‡∏¢</a>
            <a href="/"><i class="fa-solid fa-house"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
        </nav>

        <a href="/logout" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
    </div>

    <div class="main">
        <h2><i class="fa-solid fa-database"></i> ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå AI</h2>
        
        <div class="table-container">
            <table id="makhaenTable" class="display nowrap" style="width:100%">
                <thead>
                    <tr>
                        <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</th>
                        <th>‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (AI)</th>
                        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à</th>
                        <th>‡∏û‡∏¥‡∏Å‡∏±‡∏î (Lat, Lng)</th>
                        <th>‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à / ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in data %}
                    <tr id="row-{{ d.id }}">
                        <td>
                            <a href="/static/uploads/{{ d.img_name }}" target="_blank">
                                <img src="/static/uploads/{{ d.img_name }}" 
                                     width="60" height="60" 
                                     onerror="this.src='https://via.placeholder.com/60?text=No+Img'">
                            </a>
                        </td>
                        <td>
                            {% if d.prediction == 'Zanthoxylum' or d.prediction == '‡∏°‡∏∞‡πÅ‡∏Ç‡∏ß‡πà‡∏ô' %}
                                <span class="badge-ai bg-zantho">‚úÖ ‡∏°‡∏∞‡πÅ‡∏Ç‡∏ß‡πà‡∏ô</span>
                            {% else %}
                                <span class="badge-ai bg-other">{{ d.prediction }}</span>
                            {% endif %}
                        </td>
                        <td style="font-weight: bold; color: #2e7d32;">{{ "%.2f"|format(d.confidence|float) }}%</td>
                        <td>
                            <code style="font-size: 11px;">{{ "%.5f"|format(d.lat|float) }},<br>{{ "%.5f"|format(d.lng|float) }}</code>
                        </td>
                        <td>
                            <strong>{{ d.surveyor }}</strong><br>
                            <small style="color: #666;">{{ d.timestamp }}</small>
                        </td>
                        <td>
                            <a href="/dashboard?lat={{ d.lat }}&lng={{ d.lng }}" class="btn btn-map">üìç ‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
                            {% if role == 'admin' %}
                                <button class="btn btn-del" onclick="deleteData('{{ d.id }}')">üóëÔ∏è ‡∏•‡∏ö</button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            var table = $('#makhaenTable').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fa-solid fa-file-excel"></i> Export Excel',
                        className: 'btn btn-excel',
                        title: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏°‡∏∞‡πÅ‡∏Ç‡∏ß‡πà‡∏ô_' + new Date().toLocaleDateString()
                    },
                    {
                        extend: 'csvHtml5',
                        text: '<i class="fa-solid fa-file-csv"></i> Export CSV',
                        className: 'btn btn-csv',
                        title: 'Makhaen_Data_Log'
                    }
                ],
                language: {
                    search: "üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤:",
                    lengthMenu: "‡πÅ‡∏™‡∏î‡∏á _MENU_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    info: "‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà _START_ ‡∏ñ‡∏∂‡∏á _END_ ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î _TOTAL_ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
                    paginate: { next: "‡∏ñ‡∏±‡∏î‡πÑ‡∏õ", previous: "‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤" }
                },
                responsive: true,
                order: [[4, "desc"]] // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
            });

            window.deleteData = function(id) {
                Swal.fire({
                    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?',
                    text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
                    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/api/delete/' + id, { method: 'DELETE' })
                        .then(response => response.json())
                        .then(data => {
                            if(data.status === 'success') {
                                Swal.fire('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                                table.row('#row-' + id).remove().draw(false);
                            } else {
                                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', data.message, 'error');
                            }
                        })
                        .catch(err => Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error'));
                    }
                })
            }
        });
    </script>
</body>
</html>
